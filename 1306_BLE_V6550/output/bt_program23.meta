define DEBUG_RF_INIT
define SECURE_CONNECTION
define SIMPLE_PAIRING
define REVD
define ROMCODE
define PATCH
define SDKCODE
INCLUDE "bt_format"
org 0x0000  // start from patch ram address start


//define P_TIMER_DEMO
//define P_LPM

//define P_EEPROM_DEMO

//define P_BLE_WRITE
//define P_BLE_NOTIFY



	bbit1 8,pf_patch_ext
	beq patch02_7,p_txon
	beq patch03_0,p_initialize_radio_cont
	beq patch0e_0,p_app_init	
	branch p_patch

pf_patch_ext:
	rtneq patch3f_7
	branch p_patch_ext

p_idle_process:	



	branch p_idle_process_ext



p_cb_event_timer:
	branch p_cb_event_timer_ext
	



p_app_init_clear_memalloc:
	arg mem_memalloc_start, contw
	arg mem_memalloc_start, temp
	arg mem_memalloc_end, pdata
	isub temp, loopcnt
	branch clear_mem

p_mesh_iic_init:
//	jam 0,0x8081
	jam gpcfg_output_high,core_gpio_conf+2
	jam gpcfg_iic_scl|gpcfg_pullup,core_gpio_conf+1
	jam gpcfg_iic_sda|gpcfg_pullup,core_gpio_conf+0
	branch clear_eeprom_size_2k	


p_app_init:
//	setarg mem_context
//	call ice_set_write_bp
	call wdt_set_disable
	call p_app_init_clear_memalloc




	branch p_app_init_ext







p_gpio_config_output:
	setflip 7, temp
	branch gpio_config_output


p_pwm_disable:
	fetch 1,core_pwm_en
   	qset0 pdata
   	store 1,core_pwm_en
	rtn



	



	
p_initialize_radio_cont:
	jam 0x10,0x896f
	call initialize_radio_cont+1
	jam 0,core_syn_loopdiv_dsm_cfg
	jam 0x03,core_rx_lna_cfg3
	jam 0x20,core_rf_ldo_cfg1
	
	jam 0x28,core_tx_mixer_cfg1
	jam 0x3f,core_tx_mixer_cfg2
	rtn
	

p_txon:
	fetch 1,mem_tx_power
	beq TX_POWER_3DB,p_set_tx_power_3db
	beq TX_POWER_6DB,p_set_tx_power_6db
	beq TX_POWER_9DB,p_set_tx_power_9db
	beq TX_POWER_F5DB,p_set_tx_power_f5db
	beq TX_POWER_F20DB,p_set_tx_power_f20db
	beq TX_POWER_F30DB,p_set_tx_power_f30db
p_set_tx_power_0db:
	jam 0x8a,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x2c,core_tx_pwr_ctrl2
	jam 0x17,core_tx_pwr_ctrl3
p_set_rf_ldo_cfg89:
	jam 0xaa,core_rf_ldo_cfg8
	jam 0x0a,core_rf_ldo_cfg9
	rtn
	
p_set_tx_power_3db:
	jam 0x8a,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x48,core_tx_pwr_ctrl2
	jam 0x17,core_tx_pwr_ctrl3
	branch p_set_rf_ldo_cfg89

p_set_tx_power_6db:
	jam 0xc9,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x70,core_tx_pwr_ctrl2
	jam 0x1f,core_tx_pwr_ctrl3
	branch p_set_rf_ldo_cfg89

p_set_tx_power_9db:
	jam 0xcd,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x70,core_tx_pwr_ctrl2
	jam 0x1f,core_tx_pwr_ctrl3
	branch p_set_rf_ldo_cfg89

p_set_tx_power_f5db:
	jam 0x8a,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
p_set_tx_pwr_ctrl23:
	jam 0x18,core_tx_pwr_ctrl2
	jam 0x0f,core_tx_pwr_ctrl3
	jam 0xa3,core_rf_ldo_cfg8
	jam 0x0a,core_rf_ldo_cfg9
	rtn

p_set_tx_power_f20db:
	jam 0x85,core_tx_pwr_ctrl0
	jam 0x04,core_tx_pwr_ctrl1
	branch p_set_tx_pwr_ctrl23

p_set_tx_power_f30db:
	jam 0x83,core_tx_pwr_ctrl0
	jam 0x02,core_tx_pwr_ctrl1
	branch p_set_tx_pwr_ctrl23	

	


p_patch:
	branch assert

p_patch_ext:

	branch assert

p_idle_process_ext:
	rtn

p_cb_event_timer_ext:
	rtn








p_le_scan:
	call p_anchor_protect_check
	rtn user
	call p_conn_event_check
	rtn user
	branch le_scan+1
	

p_anchor_protect_check:
	call disable_user
	fetch 1, mem_le_state
	and pdata, 0x03, pdata
	sub pdata, 3, null
	nrtn zero
	fetch 1,mem_le_state
	rtnbit1 lestate_got_first_packet
	branch enable_user
	

p_conn_event_check:
	fetcht 2,mem_le_scan_window
	arg 4,queue
	branch sniff_check_window


p_le_send_adv_ind:
	jam 0x42, mem_le_txheader
	jam 3, mem_le_adv_data_len
	jam 2,mem_le_adv_data
	jam 1,mem_le_adv_data+1
	jam 2,mem_le_adv_data+2
	branch le_send_adv_ind+8



p_le_scan_patch:

	rtn

p_process_bb_event:
	deposit regc
	beq BT_EVT_LE_CONNECTED, p_ble_connted
	beq BT_EVT_LE_DISCONNECTED, p_ble_disconnted
//	beq BT_EVT_LE_PARSE_CONN_PAPA_UPDATE_RSP, p_parse_conn_para_update_rsp
	rtn
//p_parse_conn_para_update_rsp:
//	fetch 2, mem_le_l2cap_signaling_conn_param_update_rsp_result
//	rtn

p_ble_disconnted:
	call queue_init
	branch app_ble_start_adv

p_ble_connted:
	branch app_lpm_mult_enable




//p_conn_para_update_request:
//	setarg 12                                       
//	store 2, mem_le_interval_min       //connIntervalMin = 40 * 1.25ms = 50ms
//	setarg 12
//	istore 2,  contw                              //connIntervalMax = 40 * 1.25ms = 50ms
//	setarg 0 
//	istore 2,  contw                              //connSlaveLatency:0
//	setarg 300                                     //connSupervisionTimeout = 300 * 10ms = 3s
//	istore 2, contw	
//	branch le_l2cap_tx_update_req











p_app_init_ext:
	
//
	setarg p_idle_process
	store 2,mem_cb_idle_process

	setarg p_cb_event_timer
	store 2,mem_cb_event_timer


	//BLE evt handle callback
	setarg p_process_bb_event 
	store 2,mem_cb_bb_event_process

	setarg lpm_write_gpio_wakeup
	store 2,mem_cb_before_lpm_sleep

//	
	call le_modified_name
	call p_le_param_init
	branch  queue_init

p_le_param_init:
	//////////////////MTU/////////////
	jam 0x17,mem_le_local_mtu
	////////////////justwork/////////
	setarg 0x1b
 	store 2,mem_le_pairing_handle
 	call le_set_config_fixed_ltk
	call le_set_fixed_ltk
	call le_set_justwork
	branch le_set_config_read_authentication	
	rtn


		

