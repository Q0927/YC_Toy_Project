define DEBUG_RF_INIT
define SECURE_CONNECTION
define SIMPLE_PAIRING
define REVD
define ROMCODE
define PATCH
define SDKCODE
INCLUDE "bt_format"
org 0x0000  // start from patch ram address start

//define P_ADC_ENABLE
//define P_TIMER_DEMO

//define P_LPM
//define FCC_AUTH

define G24_ACK_DISABLE
define G24_TX

//define G24_ACK_DISABLE
//define G24_RX




	bbit1 8,pf_patch_ext
	beq patch02_7,p_txon
	beq patch03_0,p_initialize_radio_cont
	beq patch0e_0,p_app_init	
	branch p_patch

pf_patch_ext:
	rtneq patch3f_7
	branch p_patch_ext

p_idle_process:	



	branch p_idle_process_ext



p_cb_event_timer:
	branch p_cb_event_timer_ext
	



p_app_init_clear_memalloc:
	arg mem_memalloc_start, contw
	arg mem_memalloc_start, temp
	arg mem_memalloc_end, pdata
	isub temp, loopcnt
	branch clear_mem

p_mesh_iic_init:
//	jam 0,0x8081
	jam gpcfg_output_high,core_gpio_conf+2
	jam gpcfg_iic_scl|gpcfg_pullup,core_gpio_conf+1
	jam gpcfg_iic_sda|gpcfg_pullup,core_gpio_conf+0
	branch clear_eeprom_size_2k	


p_app_init:
//	setarg mem_context
//	call ice_set_write_bp
	call wdt_set_disable
	call p_app_init_clear_memalloc




	branch p_app_init_ext







p_gpio_config_output:
	setflip 7, temp
	branch gpio_config_output


p_pwm_disable:
	fetch 1,core_pwm_en
   	qset0 pdata
   	store 1,core_pwm_en
	rtn



	



	
p_initialize_radio_cont:
	jam 0x10,0x896f
	call initialize_radio_cont+1
	jam 0,core_syn_loopdiv_dsm_cfg
	jam 0x03,core_rx_lna_cfg3
	jam 0x20,core_rf_ldo_cfg1
	
	jam 0x28,core_tx_mixer_cfg1
	jam 0x3f,core_tx_mixer_cfg2
	rtn
	

p_txon:
	fetch 1,mem_tx_power
	beq TX_POWER_3DB,p_set_tx_power_3db
	beq TX_POWER_6DB,p_set_tx_power_6db
	beq TX_POWER_9DB,p_set_tx_power_9db
	beq TX_POWER_F5DB,p_set_tx_power_f5db
	beq TX_POWER_F20DB,p_set_tx_power_f20db
	beq TX_POWER_F30DB,p_set_tx_power_f30db
p_set_tx_power_0db:
	jam 0x8a,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x2c,core_tx_pwr_ctrl2
	jam 0x17,core_tx_pwr_ctrl3
p_set_rf_ldo_cfg89:
	jam 0xaa,core_rf_ldo_cfg8
	jam 0x0a,core_rf_ldo_cfg9
	rtn
	
p_set_tx_power_3db:
	jam 0x8a,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x48,core_tx_pwr_ctrl2
	jam 0x17,core_tx_pwr_ctrl3
	branch p_set_rf_ldo_cfg89

p_set_tx_power_6db:
	jam 0xc9,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x70,core_tx_pwr_ctrl2
	jam 0x1f,core_tx_pwr_ctrl3
	branch p_set_rf_ldo_cfg89

p_set_tx_power_9db:
	jam 0xcd,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
	jam 0x70,core_tx_pwr_ctrl2
	jam 0x1f,core_tx_pwr_ctrl3
	branch p_set_rf_ldo_cfg89

p_set_tx_power_f5db:
	jam 0x8a,core_tx_pwr_ctrl0
	jam 0x0f,core_tx_pwr_ctrl1
p_set_tx_pwr_ctrl23:
	jam 0x18,core_tx_pwr_ctrl2
	jam 0x0f,core_tx_pwr_ctrl3
	jam 0xa3,core_rf_ldo_cfg8
	jam 0x0a,core_rf_ldo_cfg9
	rtn

p_set_tx_power_f20db:
	jam 0x85,core_tx_pwr_ctrl0
	jam 0x04,core_tx_pwr_ctrl1
	branch p_set_tx_pwr_ctrl23

p_set_tx_power_f30db:
	jam 0x83,core_tx_pwr_ctrl0
	jam 0x02,core_tx_pwr_ctrl1
	branch p_set_tx_pwr_ctrl23	

	


p_patch:
	branch assert

p_patch_ext:
	branch assert

p_idle_process_ext:
	call g24_sim_tx_with_datalen_set
	call g24_recved_ack_parse

	rtn

p_cb_event_timer_ext:
	call p_24g_tx_state_timer
	rtn

p_fcc_para_config_cb:

	rtn









g24_sim_tx_with_datalen_set:	
	fetch 1, mem_le_24g_tx_enable
	rtn blank
	set0 mark_24g_rxmode,mark
	jam 2, mem_24g_datalen
	branch g24_sim_tx


g24_sim_tx:
	fetch 1,mem_24g_tx_phy
	call le_enable_phy_by_pdata
	call g24_syncword_crc8
	jam 0x88,mem_rssi_hex
//	call ice_break
	call g24_transmit_prep
	call g24_transmit_receive_ack
	call g24_end_of_packet
	fetch 1,mem_24g_no_ack	//tx noack
	beq no_ack_24g,p_g24_transmit_no_ack
	nbranch p_g24_transmit_no_ack, user3    //if(user3 == 0) means a invaild packet.
	nbranch p_g24_transmit_no_ack,sync
	call p_24g_recved_ack
p_g24_transmit_no_ack:	
	random pdata 
	arg 0x1ff,temp
	iand temp,pdata
	add pdata,250,pdata
	branch delay


p_24g_recved_ack:
	jam 1, mem_le_24g_recv_ack_flag
	rtn

g24_recved_ack_parse:
	fetch 1, mem_le_24g_recv_ack_flag
	rtn blank
	jam 0, mem_le_24g_recv_ack_flag
	rtn




	
p_24g_tx_state_timer_init:
	setarg 10
	store 2, mem_le_24g_tx_state_timeout
	rtn

p_24g_tx_state_timer:
	arg mem_le_24g_tx_state_timeout,regc
	arg p_24g_tx_state_timeout, regb
	branch timer_single_step_2B
p_24g_tx_state_timeout:
	call p_24g_tx_state_timer_init
	jam 2, mem_24g_datalen	

	fetch 1, mem_le_24g_tx_enable
	beq 1, p_24g_tx_disable
	jam 1, mem_le_24g_tx_enable
	fetch 2, mem_24g_txbuf
	pincrease 1
	store 2, mem_24g_txbuf
	rtn	

p_24g_tx_disable:	
	jam 0, mem_le_24g_tx_enable
	rtn
	










p_app_init_ext:
//
	setarg p_idle_process
	store 2,mem_cb_idle_process

	setarg p_cb_event_timer
	store 2,mem_cb_event_timer

	

	setarg lpm_write_gpio_wakeup
	store 2,mem_cb_before_lpm_sleep

	setarg p_fcc_para_config_cb
	store 2,mem_fcc_config_cb
//

	jam CMD_G24ACK_DISABLE, mem_24g_no_ack


	call p_24g_tx_state_timer_init
	rtn
	

